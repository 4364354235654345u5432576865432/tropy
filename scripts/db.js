'use strict'

require('shelljs/make')

const assert = require('assert')
const pkg = require('../package')
const log = require('./log')

const { resolve, join, dirname } = require('path')
const { assign } = Object
const { Database } = require('../lib/common/db')

const home = resolve(__dirname, '..')
const DB = join(home, 'db', 'db.sqlite')


target.create = (args = []) => {
  return create(args[0]).call('close')
}

target.migrate = () => {
  const tmp = join(home, 'tmp.db')

  rm('-f', tmp)
  rm('-f', Database.schema)

  const db = new Database(tmp)

  return db
    .migrate()
    .then(() => db.version())
    .then(version => {
      (`--
-- This file is auto-generated by executing all current
-- migrations. Instead of editing this file, please create
-- migrations to incrementally modify the database, and
-- then regenerate this schema file.
--
-- To create a new empty migration, run:
--   node scripts/make migration -- <name> <sql|js>
--

-- Save the current migration number
PRAGMA user_version=${version};

-- Load sqlite3 .dump
`
      ).to(Database.schema)

      exec(`sqlite3 ${tmp} .dump >> ${Database.schema}`)
      'PRAGMA foreign_keys=ON;'.toEnd(Database.schema)

      return [Database.schema, version]
    })

    .finally(() => db.close())
    .finally(() => rm(tmp))
}

target.viz = (args = []) => {
  const sql = args[0] || DB
  const pdf = args[1] || join(home, 'doc', 'db.pdf')
  const viz = join(home, 'node_modules', '.bin', 'sqleton')

  assert(test('-f', sql), 'db not found: run `npm run db -- create`')
  mkdir('-p', dirname(pdf))

  const db = new Database(sql)

  return db
    .version()
    .then(v => {
      exec([
        viz,
        `-t "${pkg.productName} #${v}"`,
        '-f "Helvetica Neue"',
        `-o ${pdf}`,
        sql
      ].join(' '))

      return [pdf, v]
    })

    .finally(() => db.close())
}

target.rules = () => {
  for (let rule in target) info(rule)
}


function info(msg) {
  log.info(msg, { tag: 'db' })
}

function create(file) {
  file = file || DB
  rm('-f', file)

  return new Database(file).read(Database.schema)
}


module.exports = assign({}, target)
